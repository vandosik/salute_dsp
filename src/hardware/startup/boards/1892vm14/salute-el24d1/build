###################################################################################
#
# Neutrino trunk on the Elvees Salute EL24D1 board, based on ARM Cortex A9-MPCore 
#
####################################################################################

[image=0x40100000]
[virtual=armle-v7,raw +compress] .bootstrap = {
	# Watchdog can be enabled using '-W' startup option
	startup-salute-el24d1 -vvv -Nel24d1
	# '-ae' startup option allows for unaligned memory accesses
	PATH=/proc/boot procnto-smp -ae 
}
[+script] .script = {
    # Initialise the console
    procmgr_symlink ../../proc/boot/libc.so.3 /usr/lib/ldqnx.so.2

    confstr sysname KPDA

    display_msg Welcome to KPDA on the Salute EL24D1 board (ARM Cortex-A9 MPCore)
    slogger -s64k &

    #################################################################
    ## Serial driver
    #################################################################
    devc-ser8250-dw -vvv -e -F -b115200 -c144000000/16 0x38028000^2,0x60 &

    #################################################################
    ## I2C driver
    #################################################################
    i2c-designware -p0x3802c000 --u0 &
    i2c-designware -p0x3802d000 --u1 &
    i2c-designware -p0x3802e000 --u2 &

    #################################################################
    ## Graphics driver
    #################################################################
    waitfor /dev/i2c1 1

    # Start some common servers
    pipe &

#    network_setup -e 172.16.10.75 -t -i -q -d

    devc-pty
    waitfor /dev/ptyp0 4

    # Start the main shell
    SYSNAME=nto
    TERM=qansi
    HOME=/tmp
    PATH=:/bin:/usr/bin:/sbin:/usr/sbin:/proc/boot
    LD_LIBRARY_PATH=:/lib:/usr/lib:/lib/dll:/proc/boot
    
    waitfor /dev/ser1 5
    reopen /dev/ser1
    
    [+session] ksh -l &
}

# Redirect console messages
[type=link] /bin/sh=/proc/boot/ksh
[type=link] /dev/console=/dev/ser1
[type=link] /tmp=/dev/shmem

# Programs require the runtime linker (ldqnx.so) to be at a fixed location

# Shared libraries
libc.so
libz.so.2
libm.so.2
libc.so.3
libstdc++.so.6

#######################################################################
## Networking libs and drivers
#######################################################################
#devnp-1892vm14-gemac.so
#libsocket.so
#libssl.so
#libcrypto.so
#libnbutil.so
#lsm-qnet.so
## lsm-qnet-ksz.so


###########################################################################
## uncomment for USB HOST driver
###########################################################################
#devu-dwcotg.so
#libusbdi.so
#devh-usb.so
#libhiddi.so

###########################################################################
## uncomment for BLOCK driver
## substitute cam-xxx.so and fs-xxx.so with the cam drivers and filesystems
## required
###########################################################################
#libcam.so
#io-blk.so
#cam-disk.so
#fs-qnx6.so
#fs-qnx4.so
#fs-dos.so

# Executables
[data=c dperms=0755]

###########################################################################
## uncomment for Serial driver
###########################################################################
devc-ser8250-dw

#######################################################################
## Networking stuff
#######################################################################
#io-pkt-v4-hc
#random
#ping
#route
#ftp
#telnet
#inetd
#telnetd
#ftpd
#ifconfig
#netstat
#nicinfo
#fs-nfs3
#login

###########################################################################
## uncomment for MMC/SD driver
###########################################################################
#devb-mmcsd-mcom

###########################################################################
## uncomment for NAND driver
###########################################################################
#fs-etfs-mcom

###########################################################################
## uncomment for USB HOST driver
###########################################################################
#io-usb
#usb
#devb-umass
#devu-kbd

###########################################################################
## uncomment for HID devices 
###########################################################################
#io-hid

###########################################################################
## uncomment for I2C driver
###########################################################################
i2c-designware
i2c-dump

###########################################################################
## general secvices
###########################################################################
devc-pty
slogger
pipe

###########################################################################
## general commands
###########################################################################
cp
confstr
ls
cat
ksh
sleep
pidin
uname
sloginfo
slay
mount
umount
use
date
sd=shutdown
chmod
ln
rm
mv
sleep
random
dd
top
touch
stty
date
cksum

echo
mkdir
df
hostname
waitfor
ntpd

#hidview

#######################################################################
## Debug stuff
#######################################################################
qconn
pdebug

[type=link] /bin/login=/proc/boot/login

/etc/profile = {
export TZ=MSK-03
}

/etc/ntp.conf = {
server 172.16.10.72
driftfile /etc/ntp/ntp.drift
}

/etc/ftpusers = {
* allow
}
/etc/inetd.conf = {
ftp        stream tcp nowait root  /proc/boot/ftpd           in.ftpd -l
telnet     stream tcp nowait root  /proc/boot/telnetd        in.telnetd
}

/etc/services = ${QNX_TARGET}/etc/services

/etc/passwd = {
root:x:0:0:Superuser:/tmp:/bin/sh
}

/etc/shadow = {
root:365095DDA5BA51F86587F9E4E9DA5084E149C01940DC6F56F8342DBCBBA3DF88B20E80375E8EF5A63F66159F6100909F537023C2B70930D6A6EF2A3423B9BECAFM:1432602763:0:0
}

###########################################################################
## SCRIPTS
###########################################################################
[perms=u+x uid=0 gid=0] start_ntpd = {
#!/proc/boot/ksh
	ntpd -gq >/dev/null 2>&1
	ntpd -c /etc/ntp.conf
}

[perms=u+x uid=0 gid=0] network_setup = {
#!/proc/boot/ksh

random >/dev/null 2>&1 &
USE_QNET=0
USE_QCONN=0
USE_INETD=0
USE_NFS=0
USE_NTPD=0
while getopts e:tqdin  opt $*; do
	case $opt in
		e)
			IP_ADDR_ETH="$OPTARG"
			;;
		t)
			USE_NTPD=1
			;;
		q)
			USE_QNET=1
			;;
		d)
			USE_QCONN=1
			;;
		i)
			USE_INETD=1
			;;
		n)
			USE_NFS=1
			;;
	esac
done

if [ -e "/dev/socket" ]; then
	echo "Net already up"
	exit 1
fi

echo -n "Starting ethernet driver..."
waitfor /dev/random 5
waitfor /dev/slog 5
io-pkt-v4-hc -ptcpip forward,stacksize=8192 > /tmp/net.log 2>&1
# io-pkt-v4 -dcprio64 mac=005056c00018 -ptcpip forward -pqnet
# io-pkt-v4 -dcprio64 -ptcpip forward -pqnet
# io-pkt-v4 -d1890vm8-gbe receive=2048,transmit=2048 -ptcpip -pqnet
waitfor /dev/bpf0 5 >> /tmp/net.log 2>&1
waitfor /dev/socket 5 >> /tmp/net.log 2>&1

if [ -e "/dev/socket" ]; then
# 	mount -T io-pkt -o transmit=128,tx_reap=16 devnp-1892vm14-gemac.so >> /tmp/net.log 2>&1
	mount -T io-pkt -o verbose,mac=e25eff95ac76,transmit=128 devnp-1892vm14-gemac.so >> /tmp/net.log 2>&1
	ret=$?
	if [ $ret -eq 0 ]; then
		echo " OK"
	else
		echo " FAIL"
		exit 1
	fi
	if [ -n "$IP_ADDR_ETH" ]; then
		echo "Configure ethernet interface to address $IP_ADDR_ETH"
		ifconfig en0 "$IP_ADDR_ETH" up
	fi
	if [ $USE_QNET ]; then
		echo "Starting qnet..."
# 		mount -Tio-pkt -oprotected=1 lsm-qnet-ksz.so
		mount -Tio-pkt lsm-qnet.so
	fi
	if [ $USE_QCONN ]; then
		echo "Starting qconn..."
		qconn qconn_prio=250 &
	fi
	if [ $USE_INETD ]; then
		echo "Starting inetd..."
		inetd &
	fi
	if [ $USE_NTPD ]; then
		echo "Setup time..."
		echo "127.0.0.1 localhost" > /tmp/hosts
		ln -sP /tmp/hosts /etc/hosts
		start_ntpd &
	fi
	if [ $USE_NFS -eq 1 ]; then
		echo "Starting nfs..."
# 		fs-nfs3 192.168.1.80:/armle-v7 /nfs &
		waitfor /nfs 15
		for path in /etc /var /root/ /usr/lib /usr/libexec; do
			ln -sP /nfs$path $path
		done
		`which sshd`
	fi
else
	echo " FAIL"
fi
}

###########################################################################
## END OF BUILD SCRIPT
###########################################################################
